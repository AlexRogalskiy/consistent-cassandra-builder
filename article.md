# Консистентность данных при работе с Apache Cassandra

**TLDR Используейте Builder для создания объектов при сохранении информации в Apache Cassandra**

**DISCLAIMER**

> Статья не является гайдом по проектированию модели данных для Apache Cassandra. Ожидается, что читатель имеет опыт работы с Apache Cassandra. Примеры кода приводятся на Java, которые при желании можно переложить на любой другой язык

# Мотивация

Apache Cassandra - база данных, в которой запись информации гораздо быстрее чтения, поэтому особенность моделирования схемы данных для Apache Cassandra состоит в том, чтобы исключить лишние расходы на чтение. Так все, что может затормозить чтение (джойны, группировки, фильтрация по колонкам без "индексов") идет "под нож".

В реляционных базах данных модель данных проектируется от сущности, т.е Данные -> Модель -> Приложение. Для Apache Cassandra подход выворачивается наизнанку, и проектирование данных ведется для конкретного приложения, т.е. Приложение -> Модель -> Данные.

Перед программистом встают следующие проблемы:

- Каждый запрос читает данных из своей собственной таблицы, а значит одна операция записи в Apache Cassandra может выполнять несколько вставок в несколько таблиц. Дублирование данных ведет к неконсистентному состоянию, что очень нежелательно для надежных систем.
- Каждый запрос должен выполняться быстро, а значит должен быть некий "индекс" для получения данных за константное или в худшем случае логарифмическое время. Каждая колонка, участвующая в "индексе" должна быть проинициализирована

В статье предлагается вариант организации клиентского API для решения проблем с консистентностью данных и инициализации требуемых полей на базе паттернов проектирования Builder и State Machine

# Задача

Разработать приложение для бронирования номеров в отелях. Основные сценарии:

- пользователи могут фильтровать отели по звездности,
- пользователи могут находить отели рядом с метро,
- пользователи могут посмотреть список номеров по отелю,
- пользователи могут посмотреть удобства в номере,
- пользователи могут забронировать номер в отеле.
 
## Анализ задачи

По списку сценариев строится **Диаграмма Чеботко** - графическое представление физической модели данных Apache Cassandra.

![Chebotko Diagram](images/Hotels_Chebotko.jpg)

Пояснение к диаграмме Чеботко:

- поля помеченные `K` и `C` образуют первичный ключ,
- `K` - маркер ключа раздела/партиционирования (**partition key**). По ключу партиционирования возможны запросы лишь на равенство,
- `C` - маркер ключа кластеризации (**clustering key**). По ключам кластеризации возможны запросы `=`, `>`, `<`, `>=`, `<=`, `BETWEEN` в **рамках раздела**,
- `C↓` - маркер ключа кластеризации, значения в котором хранятся в порядке убывания. Поля входящие в ключ кластеризации физически хранятся на диске в отсортированном виде. Порядок по возрастанию является порядком по умолчанию.

Согласно диаграмме Чеботко в базе имеются следующие сущности:

- `hotels_by_id` - список отелей,
- `rooms_by_hotel` - список номеров в отеле,
- `reservations_by_hotel` - информация о забронированых номерах в отеле,
- `hotels_by_metro` - отели рядом со станцией метро,
- `hotels_by_stars` - отели по звезности,
- `amenities_by_room` - удобства в номере.

Можно заметить, что существуют аттрибуты, которые содержатся одновременно в нескольких таблицах. Например:

- `hotel_name` (имя отеля): содержится в `hotels_by_id`, `room_by_hotel`, `reservations_by_hotel`, `hotels_by_stars`, `hotels_by_station`,
- `hotel_id` (идентификатор отеля): содержится в `hotels_by_id`, `room_by_hotel`, `reservations_by_hotel`, `hotels_by_stars`, `hotels_by_station`,
- `stars` (уровень звезности): содержится в `hotels_by_id`, `hotels_by_stars`,
- `room_id` (идентификатор номера): содержится в `room_by_hotel`, `amenities_by_room`, `reservations_by_hotel`.

Дублирование данных позволяет избежать операций join и является общепринятым методом проектирования модели данных для Apache Cassandra. Например, чтобы получить список отелей рядом с определенной станцией метро необходимо выполнить запрос к таблице `hotels_by_station`

Добавление данных в базу данных потребует одновременной записи одинаковых данных в разные таблицы. Например, добавление нового отеля потребует записи данных в таблицы: `hotels_by_id`, `hotels_by_metro`, `hotels_by_stars`

## Решение 1. Прямое

TBD